<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Booking Table</title>
  <style>
    :root {
      --cell-size: 50px;
    }

    @media (max-width: 768px) {
      :root {
        --cell-size: calc((100vw - 20px) / 13);
      }
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f2f5;
      padding: 10px;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    table {
      border-collapse: separate;
      border-spacing: 2px 0;
      table-layout: fixed;
      width: 100%;
      max-width: 100vw;
      user-select: none;
      touch-action: manipulation;
      overflow: auto;
      display: block;
    }

    thead th {
      position: sticky;
      top: 0;
      background: #f0f0f0;
      z-index: 2;
    }

    th, td {
      width: var(--cell-size);
      height: var(--cell-size);
      border: 1px solid #ccc;
      text-align: center;
      vertical-align: middle;
      box-sizing: border-box;
      position: relative;
      background: white;
      font-size: 12px;
    }

    th.time-col, .time-right {
      background: #f0f0f0;
      font-weight: bold;
    }

    td.slot {
      cursor: pointer;
    }

    td.selected {
      background-color: #dc143c !important;
      border: none !important;
    }

    .time-label {
      position: absolute;
      left: 2px;
      right: 2px;
      font-size: 10px;
      color: white;
      background: black;
      padding: 1px 3px;
      border-radius: 3px;
      z-index: 1;
      pointer-events: none;
    }

    .time-label.start {
      top: 2px;
    }

    .time-label.end {
      bottom: 2px;
    }
  </style>
</head>
<body>

<table id="bookingTable">
  <thead>
    <tr>
      <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th>
      <th>7</th><th>8</th><th>9</th><th>10</th><th>11</th><th>12</th>
      <th class="time-col">Время</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<!-- Кнопка бронирования -->
<div style="margin-top: 20px; text-align: center;">
  <button onclick="openModal()" style="padding: 10px 20px; font-size: 16px; background: #dc143c; color: white; border: none; border-radius: 5px;">Забронировать</button>
</div>

<!-- Модальное окно -->
<div id="modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:#00000066; justify-content:center; align-items:center; z-index:1000;">
  <div style="background:white; padding:20px; border-radius:10px; width:90%; max-width:400px; box-shadow:0 0 10px rgba(0,0,0,0.3);">
    <h3 style="margin-top:0;">Введите данные</h3>
    <label>Имя:<br><input id="nameInput" style="width:100%; padding:8px; margin-bottom:10px;"></label><br>
    <label>Телефон:<br><input id="phoneInput" style="width:100%; padding:8px; margin-bottom:10px;"></label><br>
    <label>Комментарий:<br><textarea id="commentInput" style="width:100%; padding:8px; margin-bottom:10px;"></textarea></label><br>
    <div style="text-align:right;">
      <button onclick="submitForm()" style="padding: 8px 16px; background:#dc143c; color:white; border:none; border-radius:5px;">Ок</button>
      <button onclick="closeModal()" style="padding: 8px 16px; margin-left:10px;">Отмена</button>
    </div>
  </div>
</div>

<script>
  const startHour = 12;
  const endHour = 22;
  const lanes = 12;
  const tableBody = document.getElementById("tableBody");

  const timeSlots = [];
  for (let hour = startHour; hour < endHour; hour++) {
    timeSlots.push({ display: `${hour}:00`, key: `${hour}.0` });
    timeSlots.push({ display: `${hour}:30`, key: `${hour}.5` });
  }

  timeSlots.forEach(slot => {
    const row = document.createElement("tr");
    for (let lane = 0; lane < lanes; lane++) {
      const cell = document.createElement("td");
      cell.classList.add("slot");
      cell.dataset.lane = lane;
      cell.dataset.time = slot.key;
      cell.dataset.display = slot.display;
      row.appendChild(cell);
    }

    const timeCell = document.createElement("th");
    timeCell.className = "time-right";
    timeCell.textContent = slot.display;
    row.appendChild(timeCell);
    tableBody.appendChild(row);
  });

  let currentStart = null;

  function getAllSlots() {
    return document.querySelectorAll("td.slot");
  }

  function getIntervalsByLane() {
    const intervals = {};
    getAllSlots().forEach(cell => {
      if (cell.classList.contains('selected')) {
        const lane = cell.dataset.lane;
        if (!intervals[lane]) intervals[lane] = [];
        intervals[lane].push(cell);
      }
    });
    for (const lane in intervals) {
      intervals[lane].sort((a, b) => parseFloat(a.dataset.time) - parseFloat(b.dataset.time));
    }
    return intervals;
  }

  function clearLabels(cell) {
    cell.querySelectorAll('.time-label').forEach(label => label.remove());
  }

  function clearAllLabels() {
    getAllSlots().forEach(clearLabels);
  }

  function updateLabels() {
    clearAllLabels();
    const intervals = getIntervalsByLane();
    for (const lane in intervals) {
      const cells = intervals[lane];
      if (cells.length === 0) continue;

      let block = [];
      let prevTime = null;

      cells.forEach((cell, i) => {
        const time = parseFloat(cell.dataset.time);
        if (prevTime === null || time === prevTime + 0.5) {
          block.push(cell);
        } else {
          placeLabels(block);
          block = [cell];
        }
        prevTime = time;
        if (i === cells.length - 1) {
          placeLabels(block);
        }
      });
    }

    function placeLabels(cells) {
      if (cells.length === 0) return;
      const start = document.createElement("div");
      start.className = "time-label start";
      start.textContent = cells[0].dataset.display;
      cells[0].appendChild(start);

      if (cells.length > 1) {
        const end = document.createElement("div");
        end.className = "time-label end";
        end.textContent = cells[cells.length - 1].dataset.display;
        cells[cells.length - 1].appendChild(end);
      }
    }
  }

  getAllSlots().forEach(cell => {
    cell.addEventListener("click", () => {
      const isSelected = cell.classList.contains('selected');

      if (!isSelected) {
        if (!currentStart) {
          currentStart = cell;
          cell.classList.add('selected');
          updateLabels();
        } else if (cell.dataset.lane === currentStart.dataset.lane) {
          const lane = cell.dataset.lane;
          const startTime = parseFloat(currentStart.dataset.time);
          const endTime = parseFloat(cell.dataset.time);
          const min = Math.min(startTime, endTime);
          const max = Math.max(startTime, endTime);

          getAllSlots().forEach(c => {
            if (c.dataset.lane === lane) {
              const t = parseFloat(c.dataset.time);
              if (t >= min && t <= max) c.classList.add('selected');
            }
          });
          currentStart = null;
          updateLabels();
        } else {
          currentStart = cell;
          cell.classList.add('selected');
          updateLabels();
        }
      } else {
        // Клик по выделенной ячейке
        const lane = cell.dataset.lane;
        const time = parseFloat(cell.dataset.time);
        const selectedCells = Array.from(document.querySelectorAll(`td.selected[data-lane="${lane}"]`))
          .sort((a, b) => parseFloat(a.dataset.time) - parseFloat(b.dataset.time));

        const first = selectedCells[0];
        const last = selectedCells[selectedCells.length - 1];

        if (cell !== first && cell !== last) {
          return; // Нельзя снять середину
        }

        selectedCells.forEach(c => c.classList.remove('selected'));
        currentStart = null;
        updateLabels();
      }
    });
  });

  function openModal() {
    const selected = document.querySelectorAll('td.selected');
    if (selected.length === 0) {
      alert('Сначала выберите время.');
      return;
    }
    document.getElementById('modal').style.display = 'flex';
  }

  function closeModal() {
    document.getElementById('modal').style.display = 'none';
  }

  function submitForm() {
    const name = document.getElementById('nameInput').value.trim();
    const phone = document.getElementById('phoneInput').value.trim();
    const comment = document.getElementById('commentInput').value.trim();

    if (!name || !phone) {
      alert("Пожалуйста, введите имя и телефон.");
      return;
    }

    const selections = [];
    document.querySelectorAll('td.selected').forEach(cell => {
      selections.push({
        lane: parseInt(cell.dataset.lane) + 1,
        time: cell.dataset.display
      });
    });

    console.log("Имя:", name);
    console.log("Телефон:", phone);
    console.log("Комментарий:", comment);
    console.log("Выбранные слоты:", selections);

    closeModal();
    alert("Бронирование принято!");

    document.querySelectorAll('td.selected').forEach(cell => cell.classList.remove('selected'));
    currentStart = null;
    updateLabels();
  }
</script>

</body>
</html>
